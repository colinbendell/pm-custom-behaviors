<match:metadata-stage value="client-request">
    <match:variable name="PMUSER_SERVERTIMING_DESC_NAME" result="false">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC_NAME</name>
            <value>desc</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_SERVERTIMING_DUR_NAME" result="false">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DUR_NAME</name>
            <value>dur</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>

    <assign:variable>
        <name>PMUSER_SERVERTIMING_START</name>
        <value>%(AK_CURRENT_TIME_MS)</value>
        <hidden>on</hidden>
    </assign:variable>
    <assign:variable>
        <name>PMUSER_SERVERTIMING_FWD_START</name>
        <value>0</value>
        <hidden>on</hidden>
    </assign:variable>
    <assign:variable>
        <name>PMUSER_SERVERTIMING_FWD_END</name>
        <value>0</value>
        <hidden>on</hidden>
    </assign:variable>
    <!-- todo: remove req time-->
    <match:variable name="AK_CLIENT_REQUEST_END_TIME" value-in-range="1:" >
        <assign:variable>
            <name>PMUSER_SERVERTIMING_START</name>
            <value>%(PMUSER_SERVERTIMING_START)</value>
            <hidden>on</hidden>
            <transform>
                <subtract>
                    <value>%(AK_CLIENT_REQUEST_END_TIME)</value>
                </subtract>
            </transform>
        </assign:variable>
    </match:variable>
</match:metadata-stage>


<match:metadata-stage value="forward-request">
    <assign:variable>
        <name>PMUSER_SERVERTIMING_FWD_START</name>
        <value>%(AK_CURRENT_TIME_MS)</value>
        <hidden>on</hidden>
    </assign:variable>
</match:metadata-stage>

<match:metadata-stage value="forward-response">
    <assign:variable>
        <name>PMUSER_SERVERTIMING_FWD_END</name>
        <value>%(AK_CURRENT_TIME_MS)</value>
        <hidden>on</hidden>
    </assign:variable>
</match:metadata-stage>

<match:metadata-stage value="client-response">
    <match:variable name="PMUSER_SERVERTIMING_VALUE">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(PMUSER_SERVERTIMING_VALUE),</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_SERVERTIMING_DESC">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)+</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>

    <match:request.type result="false" value="CLIENT_REQ">
        <assign:variable>
            <name>ST_PREFIX</name>
            <value>remote-</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:request.type>

    <match:variable name="PMUSER_IS_CACHE_HIT" value="1">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(ST_PREFIX)hit,%(PMUSER_SERVERTIMING_VALUE)</value>
            <hidden>on</hidden>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)hit</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_IS_CACHE_MISS" value="1">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(ST_PREFIX)miss,%(PMUSER_SERVERTIMING_VALUE)</value>
            <hidden>on</hidden>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)miss</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_IS_NOSTORE" value="1">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(ST_PREFIX)nostore,%(PMUSER_SERVERTIMING_VALUE)</value>
            <hidden>on</hidden>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)nostore</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <assign:variable>
        <name>PMUSER_SERVERTIMING_DESC</name>
        <value>%(PMUSER_SERVERTIMING_DESC)+rtt_%(AK_CLIENT_RTT)+id_%(AK_REQUEST_ID)</value>
        <hidden>on</hidden>
    </assign:variable>

    <assign:variable>
        <name>ST_TOTAL</name>
        <value>%(AK_CURRENT_TIME_MS)</value>
        <hidden>on</hidden>
        <transform>
            <subtract>
                <value>%(PMUSER_SERVERTIMING_START)</value>
            </subtract>
        </transform>
    </assign:variable>

    <assign:variable>
        <name>ST_DURATION</name>
        <value>%(ST_TOTAL)</value>
        <hidden>on</hidden>
    </assign:variable>
    <match:variable name="PMUSER_SERVERTIMING_FWD_START" value-in-range="1:">
        <match:variable name="PMUSER_SERVERTIMING_FWD_END" value-in-range="1:">
            <assign:variable>
                <name>ST_DURATION</name>
                <value>%(ST_TOTAL)</value>
                <hidden>on</hidden>
                <transform>
                    <subtract>
                        <value>%(PMUSER_SERVERTIMING_FWD_END)</value>
                    </subtract>
                    <add>
                        <value>%(PMUSER_SERVERTIMING_FWD_START)</value>
                    </add>
                </transform>
            </assign:variable>
        </match:variable>
    </match:variable>

    <assign:variable>
        <name>PMUSER_SERVERTIMING_START</name>
        <value>%(PMUSER_SERVERTIMING_START)</value>
        <hidden>on</hidden>
        <transform>
            <substitute>
                <regex>(\d{3})$</regex>
                <replacement>.$1</replacement>
            </substitute>
        </transform>
    </assign:variable>


    <assign:variable>
        <name>PMUSER_SERVERTIMING</name>
        <value>%(PMUSER_SERVERTIMING)cdn;%(PMUSER_SERVERTIMING_DUR_NAME)=%(ST_DURATION);start=%(PMUSER_SERVERTIMING_START);total=%(ST_TOTAL);%(PMUSER_SERVERTIMING_DESC_NAME)="%(PMUSER_SERVERTIMING_DESC)"</value>
        <hidden>on</hidden>
    </assign:variable>
    <edgeservices:modify-outgoing-response.add-header>
        <name>Server-Timing</name>
        <value>%(PMUSER_SERVERTIMING)</value>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.add-header>

    <!-- pass along a running Total for convenience calculations -->
    <edgeservices:modify-outgoing-response.remove-header>
        <name>Server-Timing-Total</name>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.remove-header>
    <edgeservices:modify-outgoing-response.remove-header>
        <name>Server-Timing-Last-Total</name>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.remove-header>

    <edgeservices:modify-outgoing-response.remove-header>
        <name>Server-Timing-Start</name>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.remove-header>
    <edgeservices:modify-outgoing-response.remove-header>
        <name>Server-Timing-Last-Start</name>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.remove-header>
</match:metadata-stage>