<match:metadata-stage value="client-request">
    <assign:variable>
        <name>PMUSER_SERVERTIMING_START</name>
        <value>%(AK_CURRENT_TIME)</value>
        <hidden>on</hidden>
    </assign:variable>
    <!-- todo: remove req time-->
    <match:variable name="AK_CLIENT_TRANSFER_TIME" value-in-range="1:" >
        <assign:variable>
            <name>PMUSER_SERVERTIMING_START</name>
            <value>%(PMUSER_SERVERTIMING_START)</value>
            <hidden>on</hidden>
            <transform>
                <subtract>
                    <value>%(AK_CLIENT_TRANSFER_TIME)</value>
                </subtract>
            </transform>
        </assign:variable>
    </match:variable>
</match:metadata-stage>

<match:metadata-stage value="client-response">
    <match:variable name="PMUSER_SERVERTIMING_VALUE">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(PMUSER_SERVERTIMING_VALUE),</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_SERVERTIMING_DESC">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)+</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>

    <match:request.type result="false" value="CLIENT_REQ">
        <assign:variable>
            <name>ST_PREFIX</name>
            <value>remote-</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:request.type>

    <match:variable name="PMUSER_IS_CACHE_HIT" value="1">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(ST_PREFIX)hit,%(PMUSER_SERVERTIMING_VALUE)</value>
            <hidden>on</hidden>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)hit</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_IS_CACHE_MISS" value="1">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(ST_PREFIX)miss,%(PMUSER_SERVERTIMING_VALUE)</value>
            <hidden>on</hidden>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)miss</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <match:variable name="PMUSER_IS_NOSTORE" value="1">
        <assign:variable>
            <name>PMUSER_SERVERTIMING_VALUE</name>
            <value>%(ST_PREFIX)nostore,%(PMUSER_SERVERTIMING_VALUE)</value>
            <hidden>on</hidden>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SERVERTIMING_DESC</name>
            <value>%(PMUSER_SERVERTIMING_DESC)nostore</value>
            <hidden>on</hidden>
        </assign:variable>
    </match:variable>
    <assign:variable>
        <name>PMUSER_SERVERTIMING_DESC</name>
        <value>%(PMUSER_SERVERTIMING_DESC)+rtt=%(AK_CLIENT_RTT)+id=%(AK_REQUEST_ID)</value>
        <hidden>on</hidden>
    </assign:variable>

    <assign:variable>
        <name>ST_TOTAL</name>
        <value>%(AK_CLIENT_TURNAROUND_TIME)</value>
        <hidden>on</hidden>
    </assign:variable>
    <match:variable name="AK_CLIENT_TRANSFER_TIME" value-in-range="1:">
        <assign:variable>
            <name>ST_TOTAL</name>
            <value>%(ST_TOTAL)</value>
            <hidden>on</hidden>
            <transform>
                <add>
                    <value>%(AK_CLIENT_TRANSFER_TIME)</value>
                </add>
            </transform>
        </assign:variable>
    </match:variable>

    <assign:variable>
        <name>ST_DURATION</name>
        <value>%(ST_TOTAL)</value>
        <hidden>on</hidden>
    </assign:variable>

    <match:response.header name="Server-Timing-Sum" value-in-range="1:">
        <assign:extract-value>
            <variable-name>ST_TOTAL_CHILD</variable-name>
            <location>Response_Header</location>
            <location-id>Server-Timing-Sum</location-id>
        </assign:extract-value>
        <assign:variable>
            <name>ST_DURATION</name>
            <value>%(ST_DURATION)</value>
            <hidden>on</hidden>
            <transform>
                <subtract>
                    <value>%(ST_TOTAL_CHILD)</value>
                </subtract>
            </transform>
        </assign:variable>
    </match:response.header>

    <assign:variable>
        <name>PMUSER_SERVERTIMING</name>
        <value>%(PMUSER_SERVERTIMING)cdn;duration=%(ST_DURATION);start=%(PMUSER_START_TIME);total=%(ST_TOTAL);description=%(PMUSER_SERVERTIMING_DESC)</value>
        <hidden>on</hidden>
    </assign:variable>
    <edgeservices:modify-outgoing-response.add-header>
        <name>Server-Timing</name>
        <value>%(PMUSER_SERVERTIMING)</value>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.add-header>

    <!-- pass along a running Total for convenience calculations -->
    <edgeservices:modify-outgoing-response.remove-header>
        <name>Server-Timing-Sum</name>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.remove-header>
    <edgeservices:modify-outgoing-response.add-header>
        <name>Server-Timing-Sum</name>
        <value>%(ST_TOTAL)</value>
        <status>on</status>
        <edge-only>off</edge-only>
    </edgeservices:modify-outgoing-response.add-header>
</match:metadata-stage>