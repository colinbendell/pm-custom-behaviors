<match:metadata-stage value="client-request forward-response client-response">
    <match:metadata-stage value="client-request">
        <assign:variable>
            <name>PMUSER_CONTENT_TYPE_HEADER</name>
            <value>Content-Type</value>
        </assign:variable>
    </match:metadata-stage>

    <!-- fix incoming Content-Type so that we replace ; with , -->
    <!-- append ,id=$(request_id) if present -->
    <match:metadata-stage value="forward-response">
        <match:variable name="PMUSER_LOG_CONTENT_TYPE_V" value="EMPTY_STRING" result="false">
            <assign:variable>
                <name>PMUSER_LOG_CONTENT_TYPE_V</name>
                <value>%(PMUSER_LOG_CONTENT_TYPE_V)</value>
                <hidden>off</hidden>
                <sensitive>off</sensitive>
                <transform>
                    <substitute>
                        <regex>[;,]id=[^;,]*</regex>
                        <replacement/>
                        <flags>g</flags>
                    </substitute>
                </transform>
            </assign:variable>
            <match:variable name="PMUSER_LOG_ORIGIN_REQUESTID_V" value="EMPTY_STRING" result="false">
                <assign:variable>
                    <name>PMUSER_LOG_CONTENT_TYPE_V</name>
                    <value>%(PMUSER_LOG_CONTENT_TYPE_V);id=%(PMUSER_LOG_ORIGIN_REQUESTID_V)</value>
                    <hidden>off</hidden>
                    <sensitive>off</sensitive>
                    <transform>
                        <substitute>
                            <regex>;</regex>
                            <replacement>,</replacement>
                            <flags>g</flags>
                        </substitute>
                    </transform>
                </assign:variable>
            </match:variable>

            <edgeservices:modify-incoming-response.remove-header>
                <name>%(PMUSER_CONTENT_TYPE_HEADER)</name>
                <status>on</status>
            </edgeservices:modify-incoming-response.remove-header>
            <edgeservices:modify-incoming-response.add-header>
                <name>%(PMUSER_CONTENT_TYPE_HEADER)</name>
                <value>%(PMUSER_LOG_CONTENT_TYPE_V)</value>
                <status>on</status>
            </edgeservices:modify-incoming-response.add-header>
        </match:variable>
    </match:metadata-stage>

    <!-- on the way out to the user fix incoming Content-Type so that we replace , with ; -->
    <!-- and strip the ,id=$(request_id) if present -->
    <match:metadata-stage value="client-response">
        <match:variable name="PMUSER_LOG_CONTENT_TYPE_V" value="EMPTY_STRING" result="false">
            <match:request.type value="CLIENT_REQ" result="true">
                <assign:variable>
                    <name>PMUSER_LOG_CONTENT_TYPE_V</name>
                    <value>%(PMUSER_LOG_CONTENT_TYPE_V)</value>
                    <hidden>off</hidden>
                    <sensitive>off</sensitive>
                    <transform>
                        <substitute>
                            <regex>[;,]id=[^;,]*</regex>
                            <replacement/>
                            <flags>g</flags>
                        </substitute>
                    </transform>
                </assign:variable>
                <assign:variable>
                    <name>PMUSER_LOG_CONTENT_TYPE_V</name>
                    <value>%(PMUSER_LOG_CONTENT_TYPE_V)</value>
                    <hidden>off</hidden>
                    <sensitive>off</sensitive>
                    <transform>
                        <substitute>
                            <regex>,</regex>
                            <replacement>;</replacement>
                            <flags>g</flags>
                        </substitute>
                    </transform>
                </assign:variable>
            </match:request.type>
            
            <edgeservices:modify-outgoing-response.remove-header>
                <name>%(PMUSER_CONTENT_TYPE_HEADER)</name>
                <status>on</status>
                <edge-only>off</edge-only>
            </edgeservices:modify-outgoing-response.remove-header>
            <edgeservices:modify-outgoing-response.add-header>
                <name>%(PMUSER_CONTENT_TYPE_HEADER)</name>
                <value>%(PMUSER_LOG_CONTENT_TYPE_V)</value>
                <status>on</status>
                <edge-only>off</edge-only>
            </edgeservices:modify-outgoing-response.add-header>
        </match:variable>
    </match:metadata-stage>
</match:metadata-stage>
