<match:variable name="PMUSER_JWT_VALUE">
    <assign:variable>
        <name>PMUSER_PEM</name>
        <value>%(PMUSER_PEM)</value>
        <hidden>off</hidden>
        <sensitive>off</sensitive>
        <transform>
            <substitute>
                <regex>_</regex>
                <replacement>/</replacement>
                <flags>g</flags>
            </substitute>
            <substitute>
                <regex>-</regex>
                <replacement>+</replacement>
                <flags>g</flags>
            </substitute>
            <substitute>
                <regex>\+\+\+\+\+</regex>
                <replacement>-----</replacement>
                <flags>g</flags>
            </substitute>
        </transform>
    </assign:variable>
    <match:variable name="PMUSER_JWT_VALUE">
        <assign:variable>
            <name>PMUSER_SIGNATURE</name>
            <value>%(PMUSER_JWT_VALUE)</value>
            <hidden>off</hidden>
            <sensitive>off</sensitive>
            <transform>
                <substitute>
                    <regex>_</regex>
                    <replacement>/</replacement>
                    <flags>g</flags>
                </substitute>
                <substitute>
                    <regex>-</regex>
                    <replacement>+</replacement>
                    <flags>g</flags>
                </substitute>
            </transform>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_DATA</name>
            <value>%(PMUSER_SIGNATURE)</value>
            <hidden>off</hidden>
            <sensitive>off</sensitive>
            <transform>
                <substitute>
                    <regex>\.[^.]+$</regex>
                    <replacement></replacement>
                    <flags>g</flags>
                </substitute>
            </transform>
        </assign:variable>
        <assign:variable>
            <name>PMUSER_SIGNATURE</name>
            <value>%(PMUSER_SIGNATURE)</value>
            <hidden>off</hidden>
            <sensitive>off</sensitive>
            <transform>
                <substitute>
                    <regex>^[^.]+\.[^.]+\.</regex>
                    <replacement></replacement>
                    <flags>g</flags>
                </substitute>
            </transform>
        </assign:variable>
    </match:variable>

    <auth:acl.deny>jwt-deny</auth:acl.deny>

    <assign:variable>
        <name>PMUSER_VERIFY</name>
        <value>0</value>
        <hidden>off</hidden>
        <sensitive>off</sensitive>
        <transform>
            <verify>
                <data>%(PMUSER_DATA)</data>
                <max-data-size>640KB</max-data-size>
                <pubkey>%(PMUSER_PEM)</pubkey>
                <signature>%(PMUSER_SIGNATURE)</signature>
                <algorithm>RSA</algorithm>
                <hash>sha256</hash>
            </verify>
        </transform>
    </assign:variable>
    <match:variable name="PMUSER_VERIFY" value-case="on" value-wildcard="off" value="1" result="true">
        <auth:acl.allow>jwt-deny</auth:acl.allow>
    </match:variable>

    <match:metadata-stage value="ipa-response">
        <assign:variable>
            <name>PMUSER_VERIFY_IPA</name>
            <value>0</value>
            <hidden>off</hidden>
            <sensitive>off</sensitive>
            <transform>
                <verify>
                    <data>%(PMUSER_DATA)</data>
                    <max-data-size>640KB</max-data-size>
                    <pubkey>%(PMUSER_PEM)</pubkey>
                    <signature>%(PMUSER_SIGNATURE)</signature>
                    <algorithm>RSA</algorithm>
                    <hash>sha256</hash>
                </verify>
            </transform>
        </assign:variable>
        <match:variable name="PMUSER_VERIFY_IPA" value-case="on" value-wildcard="off" value="1" result="true">
            <auth:acl.allow>jwt-deny</auth:acl.allow>
        </match:variable>
    </match:metadata-stage>
</match:variable>